# 메모리 관리

## 메모리 오버레이

메모리 용량보다 큰 프로그램을 실행시키기 위해서 메모리 오버레이 방식으로 처리합니다. 메모리 오버레이란 물리 메모리 용량보다 프로그램 크기가 더 클 경우에는 전체 프로그램을 메모리에 가져오는 대신 적당한 크기로 잘라서 가져오는 기법입니다.

`overlay`는 겹겹이 쌓다 혹은 중첩시키다라는 뜻을 가지고 있습니다. 메모리 오버레이는 하나의 메모리에 여러 프로그램을 겹겹이 쌓고 실행하는 것을 말합니다.

## 메모리 오버레이 사용 예시

대표적으로 아래아 한글이 있는데, 문서 편집기에는 기본 문서 편집 기능 외에 맞춤법 검사, 출력, 그림판 등의 기능이 있습니다. 이러한 기능은 각각 모듈 형태로 분리되어 있다가 프로그램이 실행되면 필요한 모듈만 메모리에 올라와 실행됩니다. 

기본 문서 편집기를 사용하다 그림판이 필요하면 메모리에 그림판을 가져오고, 맞춤법 검사기가 필요하면 그림판을 쫒아내고 그 자리에 맞춤법 검사기를 가져옵니다. 프로그램 전체를 메모리에 올려놓고 실행하는 것보다 속도가 느리지만 메모리가 프로그램보다 작을 때도 실행할 수 있어 유용합니다.

메모리 오버레이에서 어떤 모듈을 가져오거나 내보낼지는 CPU 레지스터 중 하나인 프로그램 카운터가 결정합니다. 프로그램 카운터는 앞으로 실행할 명령어의 위치를 가르키는 레지스터로, 해당 모듈이 메모리에 없으면 메모리 관리자에게 요청하여 메모리로 가져오게 합니다.

결론은 메모리 오버레이는 한정된 메모리에서 메모리보다 큰 프로그램 실행을 가능하게 해주는다는 것이 핀트입니다. 

이것은 가상메모리 시스템의 기본이 되는 개념이기도 합니다.

이렇게 하면 메모리를 여러 조각으로 나누어 여러 프로세스에 할당할 수 있다는 의미기도 합니다.


## 스왑

메모리 오버레이를 사용하여 물리 메모리 공간보다 큰 프로그램을 실행할 수 있었지만, 여기서 생기는 문제는 다른 모듈로 교체하려고 할때 기존의 사용하지 않을 모듈을 어디에 둬야 할지가 문제가 됩니다. 하드디스크 위치에 옮겨놓으면 되겠지만, 다시 사용할 수도 있고 작업이 완료되지 않는 경우도 생길 수 있습니다.

이처럼 메모리가 모자라서 쫒겨난 프로세스는 저장장치의 특별한 공간에 모아두는데 이러한 영역을 `스왑(swap)`이라고 부릅니다. 

스왑영역에서 메모리로 데이터를 가져오는 작업은 `스왑인(swap in)`, 스왑 영역으로 데이터를 내보내는 작업은 `스왑아웃(swap out)`이라고 합니다.

스왑 영역은 메모리 관리자가 관리합니다. 원래 하드디스크와 같은 저장장치는 저장장치 관리자가 관리하지만, 스왑 영역은 메모리에서 쫒겨났다가 다시 돌아가는 데이터가 머무는 곳이기 때문에 저장장치는 장소만 빌려주고 메모리 관리자가 관리하는 것입니다.

메모리 오버레이에서는 메모리보다 큰 프로그램을 실행할 때 메모리보다 작은 크기의 모듈로 나누어서 사용합니다. 여기에 스왑을 이용하면 스왑 영역의 크기를 메모리의 크기로 인식합니다. 다시 말해 사용자는 실제 메모리 크기와 스왑 영역의 크기를 합쳐서 전체 메모리로 인식하고 사용할 수 있습니다


### 스왑인과 스왑아웃 이미지 

![스왑인과스왑아웃](https://user-images.githubusercontent.com/22395934/126871361-b1ee774b-c3dc-4e62-bc8b-034fa53e0c8d.png)

만약 실제 메모리 크기가 1GB, 스왑의 크기가 3GB라면 사용자가 인식하는 메모리는 4GB 입니다. 이는 실제 메모리가 4GB인 컴퓨터보다 속도가 느리겠지만, 스왑을 사용하면 실제 메모리의 모자란 부분을 보충할 수 있습니다. 사용자 입장에서는 실제 메모리 크기에 상관없이 큰 프로그램을 실행할 수 있는 것입니다.

실제 스왑을 사용하는 부분은 우리에게 익숙한 윈도우의 최대 절전 모드 기능입니다. 최대 절전 모드를 사용하면 CPU와 메모리의 전력 공급을 끊기 때문에 메모리에 있는 내용이 모두 사라집니다. 그러므로 원래의 작업으로 복귀시키려면 현재 메모리에 있는 데이터를 어딘가에 옮겨야 하는데 이 때 옮겨가는 곳이 스왑 영역입니다.


## 메모리 분할 방식

메모리를 어떤 크기로 나눌 것인가는 메모리 배치 정책에 해당합니다. 메모리에 여러 개의 프로세스를 배치하는 방법은 크게 가변 분할 방식과 고정 분할 방식으로 나뉩니다.

- 가변 분할 방식: 프로세스의 크기에 따라 메모리를 나눈 것입니다. 가상 메모리 시스템에서는 세그먼테이션 기법이라고 합니다.

- 고정 분할 방식: 프로세스의 크기와 상관없이 메모리를 같은 크기로 나누는 것입니다. 가상 메모리 시스템에서는 페이징이라고도 합니다.

가변 분할 방식은 한 프로세스가 연속된 공간에 배치되기 때문에 연속 메모리 할당이라고 합니다.

고정 분할 방식은 한 프로세스가 분산되어 배치되기 때문에 비연속 메모리 할당이라고 합니다.

## 가변 분할과 고정 분할 방식의 장단점

가변 분할 방식의 장점은 프로세스를 한 덩어리로 처리하여 하나의 프로세스를 연속된 공간에 배치합니다. 

단점으로는 메모리 관리가 복잡합니다. 어떤 프로세스들이 작업을 마쳐서 빈 공간이 생겼지만, 그 빈공간보다 큰 프로세스가 올라갈려면 비어있는 공간을 하나로 합치는 부가적인 작업이 소요되기 때문에 메모리 관리가 복잡합니다. 가변 분할 방식에서 발생하는 이러한 작은 빈 공간을 외부 단편화라고 합니다.

고정 분할 방식은 메모리를 일정한 크기로 나누어 관리하기 때문에 메모리 관리가 수월합니다. 가변 분할 방식의 메모리 통합 같은 부가적인 작업을 할 필요가 없습니다.

단점은 쓸모없는 공간으로 인해 메모리 낭비가 발생할 수 있습니다 . 예를들어 20KB로 일정하게 메모리를 나눴지만 만약 그보다 적은 18KB 용량의 프로세스를 실행하면 2KB 용량이 남기 때문에 메모리 공간이 낭비가 됩니다.

> 현대 운영체제에서 메모리 관리는 기본적으로 고정 분할 방식을 사용하면서 일부분은 가변 분할 방식을 혼합하고 있습니다.

## 조각 모음

가변 분할 방식에서는 메모리에 올라오는 프로세스가 차례대로 배치되기 때문에 공간 사용에 큰 문제가 없습니다. 그러나 작은 프로세스가 작업을 마치고 메모리에 나가면 그 공간이 조각으로 남아 쓸모없어질 가능성이 큽니다. 이렇게 단편화가 발생하면 이미 배치된 프로세스를 옆으로 옮겨 빈 공간들을 하나의 큰 덩어리로 만들어야 하는데 이것을 조각 모음이라고 합니다.

1. 조각 모음을 하기 위해 이동할 프로세스의 동작을 멈춥니다.
2. 프로세스를 적당한 위치로 이동합니다. 프로세스가 원래의 위치에서 이동하기 때문에 프로세스의 상대 주소값을 바꿉니다.
3. 이러한 작업을 다 마친 후 프로세스를 다시 시작합니다.

조각 모음을 하려면 프로세스를 중지시키고, 주소를 바꾸고, 다시 시작하는 작업을 해야하기 때문에 많은 시간이 걸립니다. 이처럼 가변 분할 방식은 외부 단편화로 인해 조각 모음 같은 부가적인 작업이 필요하므로 메모리 관리가 복잡합니다.

> 외부 단편화는 하드디스크와 같은 저장 장치에서도 발생합니다. 하드디스크에는 큰 동영상과 작은 문서 파일도 저장됩니다. 빈 하드디스크에 데이터를 차곡차곡 쌓이다가 데이터의 삭제와 저장을 반복하면 데이터가 여러 공간에 나뉘어 저장됩니다. 이러한 현상은 시간이 갈 수록 심해져 컴퓨터의 성능 악화를 야기합니다. 따라서 성능을 유지하려면 주기적으로 조각 모음을 실행해야 합니다.

