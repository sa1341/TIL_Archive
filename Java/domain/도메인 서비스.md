## 도메인 서비스

여러 애그리거트가 필요한 기능

도메인 영역의 코드를 작성하다 보면 한 애그리거트로 기능을 구현할 수 없을 때가 있습니다. 대표적인 예가 결제 금액 계산 로직입니다. 실제 결제 금액을 계산할 때는 다음 과 같은 내용이 필요합니다.

- 상품 애그리거트: 구매하는 상품의 가격이 필요합니다. 또한 상품에 따라 배송비가 추가되기도 합니다.

- 주문 애그리거트: 상품별로 구매 개수가 필요합니다.

- 할인 쿠폰 애그리거트: 쿠폰별로 지정한 할인 금액이나 비율에 따라 주문 총 금액을 할인합니다. 할인 쿠폰을 조건에 따라 중복 사용할 수 있다거나 지정한 카테고리의 상품에만 적용할 수 있다는 제약 조건이 있다면 할인 계산이 복잡해 집니다.

- 회원 애그리거트: 회원 등급에 따라 추가 할인이 가능합니다.


이 상황에서 실제 결제 금액을 계산해야 하는 주체는 어떤 애그리거트일까요? 총 주문 금액을 계산하는 것은 주문 애그리거트가 할 수 있지만 실제 결제금액은 이야기가 다릅니다. 총 주문 금액에서 할인 금액을 계산해야 하는데 이 할인 금액을 구하는 것은 누구 책임일까요? 할인 쿠폰이 할인 규칙을 갖고 있으니 할인 쿠폰 애그리거트가 계산해야 할까요? 그런데, 할인 쿠폰을 두 개 이상 적용할 수 있다면 단일 할인 쿠폰 애그리거트로는 총 결제 금액을 계산할 수 없습니다.

생각해 볼 수 있는 방법은 주문 애그리거트가 필요한 애그리거트나 필요 데이터를 모두 가지도록 한 뒤 할인 금액 계산 책임을 주문 애그리거트에 할당하는 것입니다.

```java
public class Order {

    private Orderer orderer;
    private List<OrderLine> orderLines;
    private List<Coupon> usedCoupons;

    private Money calculatePayAmouns() {

        Money totalAmounts = calculateTotalAmounts();

        // 쿠폰 별로 할인 금액을 구합니다.
        Money discount = 
            coupons.stream()
                .map(coupon -> calculateDiscount(coupon))
                .reduce(Money(0), (v1, v2) -> v1.add(2));
        // 회원에 따른 추가 할인을 구합니다.
        Money membershipDiscount =
            calculateDiscount(orderer.getMember().getGrade());
        // 실제 결제 금액 계산
        return totalAmounts.minus(discount).minus(membershipDiscount);
    }

    private Money calculateDiscount(Coupon coupon) {
        // orderLines의 각 상품에 대해 쿠폰을 적용해서 할인 금액을 계산하는 로직,
        // 쿠폰의 적용 조건 등을 확인하는 코드
        // 정책에 따라 복잡한 if-else와 계산 코드
        ...
    }

    private Money calculateDiscount(MemberGrade grade) {
        ... // 등급에 따라 할인 금액 계산
    }
}
```

여기서 고민거리는 결제 금액 계산 로직이 주문 애그리거트의 책임이 맞느냐에 대한 것입니다. 예를 들어, 특별 감사 세일로 전 품목에 대해 한달 간 2% 추가 할인을 하기로 했다고 합시다. 이 할인 정책은 주문 애그리거트가 갖고 있는 구성요소와는 관련이 없음에도 불구하고 결제 금액 계산 책임이 주문 애그리거트에 있다는 이유로 주문 애그리거트의 코드를 수정해야 합니다.

이렇게 한 애그리거트에 넣기에 애매한 도메인 기능을 특정 애그리거트에서 억지로 구현하면 안됩니다. 이 경우 애그리거트는 자신의 책임의 범위를 넘어서는 기능을 구현하기 때문에 코드가 길어지고 외부에 대한 의존이 높아지게 됩니다. 이는 코드를 복잡하게 만들어 수정을 어렵게 만드는 요인이 됩니다. 게다가 애그리거트의 범위를 넘어서는 도메인 개념이 애그리거트에 숨어들어서 명시적으로 드러나지 않게 됩니다.

이런 문제를 해소하는 가장 쉬운 방법이 하나 있는데 그것은 바로 도메인 서비스를 별도로 구현하는 것입니다.
