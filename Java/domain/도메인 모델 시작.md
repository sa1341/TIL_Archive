## 도메인 모델 시작

`도메인(domain)`은 개발자 입장에서 소프트웨어로 해결하고자 하는 문제 영역을 뜻합니다.

예를 들어 온라인 서점 소프트웨어는 온라인으로 책을 판매하는 데 필요한 상품조회, 구매, 결제, 배송 추적등의 기능을 제공해야 합니다. 이때, `온라인 서점`은 소프트웨어로 해결하고자 하는 문제 영역, 위에서 말한 도메인에 해당합니다.

한 도메인은 아래와 같은 그림처럼 다시 하위 도메인으로 나눌 수 있습니다. 

![Untitled Diagram](https://user-images.githubusercontent.com/22395934/97991792-3a8eea80-1e25-11eb-89e7-d6b2ca88a507.png)


카탈로그 하위 도메인은 고객에게 구매할 수 있는 상품 목록을 제공하고, 주문 하위 도메인은 고객의 주문을 처리합니다. 혜택 하위 도메인은 쿠폰이나 특별 할인과 같은 서비스를 제공하고, 배송 하위 도메인은 고객에게 구매한 상품을 전달하는 일련의 과정을 처리합니다. 한 하위 도메인은 다른 하위 도메인과 연동하여 완전한 기능을 제공합니다. 예를 들어 고객이 물건을 구매하면 주문, 결제, 배송, 혜택 하위 도메인의 기능이 엮이게 됩니다.

여기서 중요한 건 특정 도메인을 위한 소프트웨어라고 해서 도메인이 제공해야 할 모든 기능을 구현하는 것은 아닙니다. 많은 온라인 쇼핑몰이 자체적으로 배송 시스템을 구축하기보다는 외부 배송 업체의 시스템을 사용하고 배송추적에 필요한 기능만 일부 연동합니다. 유사하게 결제도 직접 구현하기 보다는 결제 대행 업체를 이용해서 처리합니다.

![Untitled Diagram (1)](https://user-images.githubusercontent.com/22395934/97993113-f8ff3f00-1e26-11eb-912f-9b4fc66de81f.png)


- 사용자 인터페이스(UI) - 사용자의 요청을 처리하고 사용자에게 정보를 보여줍니다. 여기서 사용자는 소프트웨어 사용하는 사람뿐만 아니라 외부 시스템도 사용자가 될 수 있습니다.

- 응용 - 사용자가 요청한 기능을 실행합니다. 업무 로직을 직접 구현하지 않으며 도메인 계층을 조합해서 기능을 실행합니다.

- 도메인 - 시스템이 제공할 도메인의 규칙을 구현합니다.

- 인프라스트럭처 - 데이터베이스나 메시징 시스템과 같은 외부 시스템과의 연동을 처리합니다.

아래 코드는 주문 도메인의 일부 기능을 도메인 모델 패턴으로 구현한 것입니다. 큰 틑에서 보면 OrderState는 Order에 속한 데이터이므로 배송지 정보 변경 가능 여부를 판단하는 코드를 Order로 이동할 수도 있습니다. 다음은 Order 클래스에서 판단하도록 수정한 코드를 보여주고 있습니다.

```java
public class Order {

    private OrderState state;
    private ShippingInfo shippingInfo;


    public void changeShippingInfo(ShippingInfo newShippingInfo) {
        if (!isShippingChangeable()) {
            throw new IllegalStateException("can't change shipping in" + state);
        }
        this.shippingInfo = newShippingInfo;
    }

    public boolean isShippingChangeable() {
        return state == OrderState.PAYMENT_WATING || state == OrderState.PREPARING;
    }
    ...
}


enum OrderState {
    PAYMENT_WATING, PREPARING, SHIPPED, DELIVERING, DELIVERY_COMPLTED;
}
```

배송지 변경이 가능한지 여부를 판단할 규칙이 주문 상태와 다른 정보를 함께 사용한다면 배송지 변경 가능 여부 판단을 OrderState만으로 할 수 없으므로 로직 구현을 Order에서 해야 할 것입니다.

## 도메인 모델 도출
도메인을 모델링 할 때 기본이 되는 작업은 모델을 구성하는 핵심 구성요소, 규칙, 기능을 찾는 것입니다. 이 과정은 요구사항에서 출발합니다. 주문 도메인과 관련된 몇가지 요구사항을 봅시다.

- 최소 한 종류 이상의 상품을 주문해야 합니다.
- 한 상품을 한 개 이상 주문할 수 있습니다.
- 총 주문 금액은 각 상품의 구매 가격 합을 모두 더한 금액입니다.
- 각 상품의 구매 가격 합은 상품 가격에 구매 개수를 곱한 값입니다.
- 주문할 때 배송지 정보를 반드시 지정해야 합니다.
- 배송지 정보를 받는 사람 이름, 전화번호, 주소로 구성됩니다.
- 출고 전에 주문을 취소할 수 있습니다.
- 고객이 결제를 완료하기 전에는 상품을 준비하지 않습니다.

이 요구사항에서 알 수 있는 것은 주문은 `출고 상태로 변경하기, 배송지 정보 변경하기, 주문 취소하기, 결제 완료로 변경하기`의 네 기능을 제공한다는 것입니다. 

```java
public class Order {
    // 출고 상태 변경
    public void changeShipping() {}
    // 배송 정보 변경
    public void changeShippingInfo(ShippingInfo newShippingInfo) 
    // 주문 취소
    public void cancel() {}
    // 결제 완료로 변경
    public void completePayment() {}
}
```

다음 요구사항은 주문 항목이 어떤 데이터로 구성되는지 알려줍니다.

- 한 상품을 한 개 이상 주문할 수 있습니다.
- 각 상품의 구매 가격 합은 상품 가격에 구매 개수를 곱한 값입니다.

두 요구 사항에 따르면 주문 항목을 표현하는 OrderLine은 적어도 주문할 상품, 상품의 가격, 구매 개수를 포함하고 있어야 합니다. 추가로 각 구매 항목의 구매 가격도 제공해야 합니다. 

