

## 상태검사

k8s에서 컨테이너로 애플리케이션을 실행하는 경우 **프로세스 상태 검사**를 사용해 파드를 항상 살아 있는 상태로 유지할 수 있습니다.

이 상태 검사는 단순히 애플리케이션의 주요 프로세스가 항상 실행되게 합니다.  그렇지 않은 경우 k8s가 애플리케이션을 재시작 합니다.

하지만 대부분의 경우 단순한 프로세스 상태 검사만으로는 충분하지 않습니다. 예를 들어 프로세스가 데드락에 걸려 요청을 처리할 수 없는 경우 프로세스 상태 검사는 애플리케이션의 프로세스가 여전히 동작하고 있기 때문에 애플리케이션의 상태를 정상으로 판단할 것입니다.

이러한 문제를 해결하고자 k8s에는 애플리케이션 **활성**에 대한 상태 검사를 도입했습니다.

> 활성 상태 검사는 단순히 애플리케이션의 동작 여부뿐만 아니라 정상 기능 수행여부까지 검사하고자 애플리케이션에 특화된 로직을 실행합니다. 


## 활성 프로브

일단 애플리케이션 프로세스가 구동돼 실행되면 파드의 상태 및 재시작 여부를 확인할 방법이 필요합니다.
활성 프로브는 컨테이너 단위로 정의되며, 파드의 각 컨테이너별 상태 검사를 수행합니다. 
하기 예제는 /healthy 경로로 HTTP 요청을 수행하는 활성 프로브를 추가한 예시입니다.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: kuard
spec:
  containers:
    - image: gcr.io/kuar-demo/kaurd-amd64:blue
      name: kuard
      livenessProbe:
        httpGet:
          path: /healthy
          port: 8080
        initialDelaySeconds: 5
        timeoutSeconds: 1
        periodSeconds: 10
        failureThreshold: 3
       ports:
         - containerPort:8080
           name: http
           protocol: TCP
```

위의 파드 매니페스트는 httpGet 프로브를 사용해 kuard 컨테이너 8080 포트상의 /healthy 엔드포인트로 HTTP GET 요청을 수행합니다.


- initialDelaySeconds: 파드의 모든 컨테이너가 생성되고 5초 후에 상태 검사를 수행하는 것을 의미합니다.
- timeoutSeconds: 프로브는 1초의 타임아웃 내에 응답함으로 설정, 응답코드는 200이상 400미만인 경우에만 성공으로 간주함.
- periodSeconds: 쿠버네티스에서 10초마다 프로브를 호출합니다.
- failureThreshold: 세번 이상 연속으로 실패하면 컨테이너는 중지 후 재시작 됩니다.


## 준비 프로브

활성 프로브가 상태검사를 위한 유일한 방법은 아닙니다. 쿠버네티스는 **활성**과 **준비**를 구분합니다.
활성은 애플리케이션의 정상 동작 여부를 검사합니다. 활성 검사에 실패한 컨테이너는 재시작 됩니다.
준비는 컨테이너가 사용자 요청 처리에 대한 준비 유무를 검사합니다. 준비 상태 검사에서 실패한 컨테이너는 서비스 로드벨런서에서 제거됩니다.

준비 프로브는 활성 프로브와 비슷하게 설정됩니다. 


## 시작 프로브
시작 프로브는 느리게 구동되는 컨테이너를 관리하기 위한 대안으로 최근에 도입됬습니다.
파드가 구동되면 파드의 다른 프로브가 구동되기 전에 이 시작 프로브가 실행됩니다. 
시작 프로브는 시간이 초과 되거나 성공할 때까지 진행되며, 이때 활성 프로브로 인계됩니다.
시작 프로브를 사용하면 느리게 구동되는 컨테이너에 대해 느리게 폴링하는 동시에 느리게 구동되는 컨테이너가 초기화 된 후에 응답 활성 검사를 가능하게 할 수 있습니다.

##  고급 프로브 구성

쿠버네티스의 프로브에는 파드 구동 후 프로브를 시작하고자 대기하는 시간, 실제 실패로 간주해야 하는 실패 수, 실패 수를 재설정하는데 필요한 성공횟수를 포함한 여러 가지 고급 옵션이 있습니다. 이러한 모든 컨피규레이션은 지정되지 않는 경우 기본 값으로 설정되지만 본질적으로 애플리케이션이 불안정하거나 시작하는데 오랜 시간이 걸리는 경우와 같은 고급 사용 사례에 필요할 수 있습니다.




> 참고도서:  Kubernates Up & Running
