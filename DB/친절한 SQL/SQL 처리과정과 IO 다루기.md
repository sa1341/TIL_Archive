# SQL 처리과정과 IO

## 1. SQL 파싱과 최적화

SQL은 `Structed Query Language`의 줄임말입니다. 말 그대로 구조적 질의 언어입니다. SQL은 기본적으로 구조적이고 집합적이고 선언적인 질의어입니다. 원하는 결과집합을 구조적, 집합적으로 선언하지만, 그 결과집합을 만드는 과정은 절차적일 수 밖에없습니다. 즉, 프로시저가 필요한데, 그 프로시저를 만들어 내는 DBMS 엔진이 `SQL 옵티마이저`입니다. 옵티마이저가 프로그래밍을 대신해 주는 셈인겁니다.

## 2. SQL 최적화

SQL은 실행하기 전 최적화 과정을 세분화하면 아래와 같습니다.

1.SQL 파싱: 사용자로부터 SQL을 전달받으면 가장 먼저 SQL 파서(Parser)가 파싱을 진행합니다. SQL 파싱을 요약하면 아래와 같습니다.

- 파싱 트리 생성: SQL 문을 이루는 개별 구성요소를 분석해서 파싱 트리를 생성합니다.
- Syntax 체크: 문법적 오류가 없는지 확인하고, 사용할 수 없는 키워드를 사용했거나 순서가 바르지 않거나 누락된 키워드가 있는지 확인합니다.
- Semmantic 체크: 의미상 오류가 없는지 확인하고, 존재하지 않은 테이블 또는 컬럼을 사용했는지, 사용한 오브젝트에 대한 권한이 있는지 확인합니다.

2.SQL 최적화: 파싱 다음 단계가 SQL 최적화 입니다. 옵티마이저가 그역할을 맡습니다. SQL 옵티마이저는 미리 수집한 시스템 및 오브젝트 통계정보를 바탕으로 다양한 실행경로를 생성해서 비교한 후 가장 효율적인 하나를 선택합니다. `데이터베이스 성능을 결정하는 가장 핵심적인 엔진입니다.`

3.로우 소스 생성: SQL 옵티마이저가 선택한 실행경로를 실제 실행 가능한 코드 또는 프로시저 형태로 포맷팅 하는 단계입니다. 로우 소스 생성기가 그 역할을 맡습니다.

## 3. SQL 옵티마이저

위에서 언급한것 처럼 옵티마이저는 사용자가 원하는 작업을 가장 효율적으로 수행할 수 있는 최적의 데이터 엑세스 경로를 선택해주는 DBMS의 핵심 엔진입니다. 옵티마이저의 최적화 단계를 요약하면 아래와 같습니다.

1. 사용자로부터 전달받은 쿼리를 수행하는 데 후보군이 될만한 싱핼계획들을 찾아냅니다.
2. 데이터 딕셔너리(Data Dictionary)에 미리 수집해 둔 오브젝트 통계 및 시스템 통계정보를 이용해 각 실행계획의 예상비용을 산정합니다.
3. 최저 비용을 나타내는 실행계획을 선택합니다.


> 데이터 사전이란 대부분 읽기전용으로 제공되는 테이블 및 뷰들의 집합으로 데이터베이스 전반에 대한 정보를 제공합니다. 오라클 DB는 명령이 실행될 때 마다 데이터 사전을 Access 합니다.

DBMS에도 `SQL 실행 경로 미리보기` 기능이 있습니다. 실행계획이 바로 그것입니다. 

미리보기 기능을 통해서 자신이 작성한 SQL이 테이블을 스캔하는지 인덱스를 스캔하는지, 인덱스를 스캔한다면 어떤 인덱스인지를 확인할 수 있고, 예상과 다른 방식으로 처리된다면 실행경로를 변경할 수 있습니다.


## 4. 옵티마이저 힌트

자동차 네비게이션이 보편적으로 좋은 선택을 하지만, 그 선택이 항상 최선은 아닙니다. 내비게이션 두 개를 동시에 사용할 때, 서로 다른 길로 안내하는 것을 보면 알 수 있습니다. SQL 옵티마이저도 대부분 좋은 선택을 하지만, 완벽하진 않습니다. 

SQL이 복잡할수록 실수할 가능성도 큽니다. 운전자도 자신만 아는 정보나 경험을 활용해 빨리 목적지에 도착할 수 있는 것처럼 통계정보에 담을 수 없는 데이터 또는 업무 특성을 활용해 개발자가 직접 더 효율적인 엑세스 경로를 찾아낼 수 도 있습니다. 이럴 때 옵티마이저 힌트를 이용해 데이터 엑세스 경로를 바꿀 수 있습니다.

### 힌트절 사용법

주석 기호에 `+`를 붙이면 됩니다.

```sql
SELECT /*+ INDEX(A 고객_PK) */
    고객명, 연락처, 주소, 가입일시
    FROM 고객 A
    WHERE 고객ID = '00000008';
```
    
테이블 Full Scan으로 실행하도록 힌트절을 주려면 아래와 같이 주면 됩니다.

```sql
SELECT /*+ full(A) */ *
    FROM 고객 A
    WHERE 고객ID = '00000008';
```

> 참조 문헌: 친절한 SQL 튜닝
